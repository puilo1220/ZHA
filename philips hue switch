blueprint:
  name: "Hue Dimmer v2 - Toggle & Fix"
  description: "On toggles, Hue cycles, Down button fixed."
  domain: automation
  input:
    remote_device:
      name: Hue Dimmer Switch
      selector:
        device:
          integration: mqtt
    light_entity:
      name: Light Entity
      selector:
        target:
          entity:
            domain: light
    brightness_step:
      name: Brightness Step
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"
    transition_time:
      name: Response Time
      default: 0.5
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: "s"

variables:
  target_light: !input light_entity
  step_size: !input brightness_step

mode: restart

trigger:
  - platform: device
    domain: mqtt
    device_id: !input remote_device
    type: action
    subtype: on_press
    id: "on_toggle"
  - platform: device
    domain: mqtt
    device_id: !input remote_device
    type: action
    subtype: off_press
    id: "off"
  - platform: device
    domain: mqtt
    device_id: !input remote_device
    type: action
    subtype: up_press
    id: "up"
  - platform: device
    domain: mqtt
    device_id: !input remote_device
    type: action
    subtype: down_press
    id: "down"
  - platform: device
    domain: mqtt
    device_id: !input remote_device
    type: action
    subtype: hue_press
    id: "hue_cycle"

action:
  - choose:
      - conditions:
          - condition: trigger
            id: "on_toggle"
        sequence:
          - if:
              - condition: template
                value_template: >
                  {% set entity = target_light.entity_id if target_light.entity_id is string else target_light.entity_id[0] %}
                  {{ is_state(entity, 'on') }}
            then:
              - service: light.turn_off
                target: !input light_entity
            else:
              - service: light.turn_on
                target: !input light_entity
                data:
                  brightness_pct: 100
                  transition: !input transition_time

      - conditions:
          - condition: trigger
            id: "off"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 5
              transition: !input transition_time

      - conditions:
          - condition: trigger
            id: "up"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: !input brightness_step
              transition: !input transition_time

      - conditions:
          - condition: trigger
            id: "down"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: "{{ (step_size | int) * -1 }}"
              transition: !input transition_time

# HUE BUTTON: Color Temperature Cycle (修復版)
      - conditions:
          - condition: trigger
            id: "hue"
        sequence:
          - variables:
              # 強制將 target 轉做單一 entity_id 字串
              target_entity: >
                {% if light_entity.entity_id is string %}
                  {{ light_entity.entity_id }}
                {% else %}
                  {{ light_entity.entity_id[0] }}
                {% endif %}
              
              # 獲取當前色溫，如果攞唔到就預設 3000
              current_temp: "{{ state_attr(target_entity, 'color_temp_kelvin') | int(3000) }}"

          - service: light.turn_on
            target: !input light_entity
            data:
              # 邏輯：如果大過 3500 (白光)，就變 2700 (黃光)；否則就變 4500 (白光)
              color_temp_kelvin: >
                {% if current_temp > 3500 %}
                  2700
                {% else %}
                  4500
                {% endif %}
              transition: !input transition_time
