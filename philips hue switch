blueprint:
  name: "Hue Dimmer v2 (Smooth Fix)"
  description: "Select the Hue Dimmer v2 device. Includes smooth transitions and dim-to-off fix."
  domain: automation
  input:
    remote_device:
      name: Hue Dimmer Switch
      selector:
        device:
          integration: mqtt
    light_entity:
      name: Light Entity
      selector:
        target:
          entity:
            domain: light
    brightness_step:
      name: Brightness Step
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"
    transition_time:
      name: Response Time
      default: 0.5
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: "s"

variables:
  step_val: !input brightness_step
  trans_val: !input transition_time
  target_light: !input light_entity

mode: restart

trigger:
  # This listens for ANY action from the device and we sort it in the 'action' block
  - platform: device
    domain: mqtt
    device_id: !input remote_device
    type: action

action:
  - vars:
      # This captures the button name whether it uses - or _
      action: "{{ trigger.subtype }}"
  - choose:
      # ON BUTTON
      - conditions: "{{ action in ['on', 'on-press', 'on_press'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 100
              transition: "{{ trans_val }}"

      # OFF BUTTON (Dim to 5%)
      - conditions: "{{ action in ['off', 'off-press', 'off_press'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 5
              transition: "{{ trans_val }}"

      # UP BUTTON
      - conditions: "{{ action in ['up-press', 'up_press', 'initial_press_up'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: "{{ step_val | int }}"
              transition: "{{ trans_val }}"

      # DOWN BUTTON
      - conditions: "{{ action in ['down-press', 'down_press', 'initial_press_down'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: "{{ (step_val | int) * -1 }}"
              transition: "{{ trans_val }}"

      # HUE BUTTON (Color Cycle)
      - conditions: "{{ action in ['hue', 'hue-press', 'hue_press'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              transition: "{{ trans_val }}"
              color_temp_kelvin: >
                {% set entity = target_light.entity_id if target_light.entity_id is string else target_light.entity_id[0] %}
                {% if state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 3500 %}
                  2700
                {% elif state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 2800 %}
                  4500
                {% else %}
                  3200
                {% endif %}
