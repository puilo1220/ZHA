blueprint:
  name: "Hue Dimmer v2 for IKEA TRADFRI Bulb - Fixed"
  description: "Fixed template for Hue Dimmer 929002398602 + IKEA TRADFRI Bulb."
  domain: automation
  input:
    remote_device:
      name: Hue Dimmer Switch
      selector:
        device:
          integration: mqtt
    light_entity:
      name: Light Entity
      selector:
        target:
          entity:
            domain: light
    brightness_step:
      name: Brightness Step
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

# This part is the fix: It converts the input into a variable the template can see
variables:
  target_light: !input light_entity

mode: restart

trigger:
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "on-press"
    id: "on"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "off-press"
    id: "dim_to_min"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "up-press"
    id: "br_up"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "down-press"
    id: "br_down"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "hue-press"
    id: "color_cycle"

action:
  - choose:
      - conditions: [{condition: trigger, id: "on"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 100

      - conditions: [{condition: trigger, id: "dim_to_min"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 5

      - conditions: [{condition: trigger, id: "br_up"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: !input brightness_step

      - conditions: [{condition: trigger, id: "br_down"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: -10

      - conditions: [{condition: trigger, id: "color_cycle"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              # This template is now simplified and safe
              color_temp_kelvin: >
                {% set entity = target_light.entity_id %}
                {% if state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 3500 %}
                  2700
                {% elif state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 2800 %}
                  4500
                {% else %}
                  3200
                {% endif %}
