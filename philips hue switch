blueprint:
  name: "Hue Dimmer v2 - Final Fix"
  description: "Compatible with Hue Dimmer 929002398602 and IKEA TRADFRI Bulbs."
  domain: automation
  input:
    remote_sensor:
      name: Hue Dimmer Action Sensor
      description: "Pick the 'Action' sensor (e.g., sensor.hue_dimmer_action)"
      selector:
        entity:
          domain: sensor
    light_entity:
      name: Light Entity
      selector:
        target:
          entity:
            domain: light
    brightness_step:
      name: Brightness Step
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

mode: restart

trigger:
  - platform: state
    entity_id: !input remote_sensor

action:
  - vars:
      # Capture the button pressed
      action_sent: "{{ trigger.to_state.state }}"
      # Capture the light ID for the template
      target_input: !input light_entity
  - choose:
      # ON BUTTON
      - conditions: "{{ action_sent in ['on', 'on-press', 'on_press'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 100

      # OFF BUTTON (Dims to 5%)
      - conditions: "{{ action_sent in ['off', 'off-press', 'off_press'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 5

      # UP BUTTON
      - conditions: "{{ action_sent in ['up-press', 'up_press', 'brightness_move_up'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: !input brightness_step

      # DOWN BUTTON
      - conditions: "{{ action_sent in ['down-press', 'down_press', 'brightness_move_down'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: -10

      # HUE BUTTON (Color Cycle)
      - conditions: "{{ action_sent in ['hue', 'hue-press', 'hue_press'] }}"
        sequence:
          - service: light.turn_on
            target: !input light_entity
            data:
              color_temp_kelvin: >
                {% set entity = target_input.entity_id if target_input.entity_id is string else target_input.entity_id[0] %}
                {% if state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 3500 %}
                  2700
                {% elif state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 2800 %}
                  4500
                {% else %}
                  3200
                {% endif %}
