blueprint:
  name: "Hue Dimmer v2 - Ultra Compatible"
  description: "Uses sensor state instead of device triggers for maximum compatibility."
  domain: automation
  input:
    remote_sensor:
      name: Hue Dimmer Action Sensor
      description: "Pick the 'Action' sensor of your remote (e.g., sensor.hue_dimmer_action)"
      selector:
        entity:
          domain: sensor
    light_entity:
      name: Light Entity
      selector:
        target:
          entity:
            domain: light
    brightness_step:
      name: Brightness Step
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

variables:
  target_light: !input light_entity

mode: restart

trigger:
  - platform: state
    entity_id: !input remote_sensor
    # We leave 'to:' blank so it catches EVERY button press

action:
  - vars:
      action_sent: "{{ trigger.to_state.state }}"
  - choose:
      # ON BUTTON (Handles 'on', 'on-press', or 'on_press')
      - conditions: "{{ action_sent in ['on', 'on-press', 'on_press'] }}"
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 100

      # OFF BUTTON (Dims to 5%)
      - conditions: "{{ action_sent in ['off', 'off-press', 'off_press'] }}"
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 5

      # UP BUTTON
      - conditions: "{{ action_sent in ['up-press', 'up_press', 'brightness_move_up'] }}"
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: !input brightness_step

      # DOWN BUTTON
      - conditions: "{{ action_sent in ['down-press', 'down_press', 'brightness_move_down'] }}"
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: -10

      # HUE BUTTON (Color Cycle)
      - conditions: "{{ action_sent in ['hue', 'hue-press', 'hue_press'] }}"
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              color_temp_kelvin: >
                {% set entity = target_light.entity_id %}
                {% if state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 3500 %}
                  2700
                {% elif state_attr(entity, 'color_temp_kelvin') | default(3000, true) > 2800 %}
                  4500
                {% else %}
                  3200
                {% endif %}
