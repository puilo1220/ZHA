blueprint:
  name: "Hue Dimmer v2 for IKEA TRADFRI Bulb"
  description: "Specialized for Hue Dimmer 929002398602 + IKEA TRADFRI WS Bulb via Zigbee2MQTT."
  domain: automation
  input:
    remote_device:
      name: Hue Dimmer Switch
      selector:
        device:
          integration: mqtt
    light_entity:
      name: Light Entity
      selector:
        target:
          entity:
            domain: light
    brightness_step:
      name: Brightness Step
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

mode: restart

trigger:
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "on-press"
    id: "on"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "off-press"
    id: "dim_to_min"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "up-press"
    id: "br_up"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "down-press"
    id: "br_down"
  - platform: device
    device_id: !input remote_device
    domain: mqtt
    type: action
    subtype: "hue-press"
    id: "color_cycle"

action:
  - choose:
      # ON BUTTON: Full Power
      - conditions: [{condition: trigger, id: "on"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 100

      # OFF BUTTON: Dim to 5% (Nightlight mode)
      - conditions: [{condition: trigger, id: "dim_to_min"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_pct: 5

      # UP BUTTON: Increase Brightness
      - conditions: [{condition: trigger, id: "br_up"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: !input brightness_step

      # DOWN BUTTON: Decrease Brightness
      - conditions: [{condition: trigger, id: "br_down"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              brightness_step_pct: -{{ states(brightness_step) | int(10) }}

      # HUE BUTTON: Change Color Temperature
      # Cycles through Warm, Neutral, and Cold
      - conditions: [{condition: trigger, id: "color_cycle"}]
        sequence:
          - action: light.turn_on
            target: !input light_entity
            data:
              color_temp_kelvin: >
                {% if state_attr((!input light_entity).entity_id[0], 'color_temp_kelvin') > 3500 %}
                  2700
                {% elif state_attr((!input light_entity).entity_id[0], 'color_temp_kelvin') > 2800 %}
                  4000
                {% else %}
                  3000
                {% endif %}
